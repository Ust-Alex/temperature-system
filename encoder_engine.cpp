#include "encoder_engine.h"
#include "system_config.h"  // Для глобальных настроек
#include <EncButton.h>      // Библиотека энкодера

// ============================================================================
// ЛОКАЛЬНЫЕ ПЕРЕМЕННЫЕ (видны только в этом файле)
// ============================================================================
static EncButton enc(32, 33, 25, INPUT, INPUT); // CLK=32, DT=33, SW=25
static uint32_t lastActivityTime = 0;           // Время последней активности

// ============================================================================
// ИНИЦИАЛИЗАЦИЯ ЭНКОДЕРА
// ============================================================================
void encoder_init() {
    Serial.println("[ENCODER] Инициализация энкодера...");
    
    // НАСТРОЙКА УРОВНЯ СИГНАЛА КНОПКИ
    // LOW - кнопка замыкает на GND (активный низкий уровень)
    enc.setBtnLevel(LOW);
    
    // НАСТРОЙКА ТАЙМАУТОВ (в миллисекундах)
    enc.setClickTimeout(500);   // Макс. время между кликами для двойного нажатия
    enc.setDebTimeout(50);      // Время гашения дребезга контактов
    enc.setHoldTimeout(600);    // Время до срабатывания удержания
    enc.setStepTimeout(200);    // Период импульсов при удержании
    enc.setTimeout(1000);       // Общий таймаут действия
    
    // НАСТРОЙКА ЭНКОДЕРА (декодера)
    enc.setEncReverse(0);       // 0 - нормальное направление, 1 - реверс
    enc.setEncType(EB_STEP4_LOW); // Тип сигнала: 4 фазы за щелчок, активный LOW
    enc.setFastTimeout(30);     // Таймаут быстрого поворота
    
    // Сброс счётчика энкодера
    enc.counter = 0;
    
    // Инициализация таймера неактивности
    lastActivityTime = millis();
    
    Serial.println("[ENCODER] Энкодер инициализирован (пины: CLK=32, DT=33, SW=25)");
}

// ============================================================================
// ОПРОС ЭНКОДЕРА И ВОЗВРАТ СОБЫТИЯ
// Вызывается в задаче taskEncoder каждые 10 мс
// ============================================================================
EncoderEvent_t encoder_tick() {
    enc.tick(); // Опрос библиотеки EncButton
    
    // ОБРАБОТКА ПОВОРОТА ЭНКОДЕРА
    if (enc.turn()) {
        // Сбрасываем таймер неактивности при ЛЮБОМ действии пользователя
        lastActivityTime = millis();
        
        // Определяем направление и возвращаем соответствующее событие
        if (enc.left()) {
            return EVENT_ENCODER_LEFT;
        } else if (enc.right()) {
            return EVENT_ENCODER_RIGHT;
        }
    }
    
    // ОБРАБОТКА КНОПКИ
    if (enc.click()) {
        // Сбрасываем таймер неактивности
        lastActivityTime = millis();
        
        // Проверяем двойное нажатие (библиотека EncButton умеет это определять)
        if (enc.hasClicks(2)) {
            return EVENT_BUTTON_DOUBLE;
        } else {
            return EVENT_BUTTON_CLICK;
        }
    }
    
    // Если ничего не произошло - возвращаем EVENT_NONE
    return EVENT_NONE;
}

// ============================================================================
// СБРОС ТАЙМЕРА НЕАКТИВНОСТИ
// Вызывается при любом действии пользователя
// ============================================================================
void encoder_reset_inactivity_timer() {
    lastActivityTime = millis();
}

// ============================================================================
// ПОЛУЧЕНИЕ ВРЕМЕНИ НЕАКТИВНОСТИ (в миллисекундах)
// ============================================================================
uint32_t encoder_get_inactivity_time() {
    return millis() - lastActivityTime;
}