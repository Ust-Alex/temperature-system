/**
 * rtos_tasks.cpp
 * –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –í–°–ï–• –∑–∞–¥–∞—á FreeRTOS
 */

#include "rtos_tasks.h"
#include "wifi_ap_module.h" // –î–ª—è —Ñ—É–Ω–∫—Ü–∏–π Wi-Fi –º–æ–¥—É–ª—è

// ============================================================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ============================================================================

/**
 * –í—ã–≤–æ–¥ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Å—Ç–µ–∫–∞ –∑–∞–¥–∞—á–∏
 */
static void print_stack_usage(const char* task_name) {
    UBaseType_t watermark = uxTaskGetStackHighWaterMark(NULL);
    Serial.printf("[DEBUG] %s - —Å–≤–æ–±–æ–¥–Ω—ã–π —Å—Ç–µ–∫: %u —Å–ª–æ–≤\n", task_name, watermark);
}

// ============================================================================
// –ó–ê–î–ê–ß–ê –ò–ó–ú–ï–†–ï–ù–ò–ô (–í–ê–®–ê –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø)
// ============================================================================
void taskMeasure(void* pv) {
    // –í–ê–® –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ö–û–î taskMeasure (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    // –¢–æ–ª—å–∫–æ –¥–æ–±–∞–≤—å—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤ –Ω–∞—á–∞–ª–µ —Ü–∏–∫–ª–∞:
    // static uint32_t lastCheck = 0;
    // if (millis() - lastCheck > 10000) {
    //     print_stack_usage("MeasureTask");
    //     lastCheck = millis();
    // }
}

// ============================================================================
// –ó–ê–î–ê–ß–ê –î–ò–°–ü–õ–ï–Ø (–í–ê–®–ê –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø)
// ============================================================================
void taskDisplay(void* pv) {
    // –í–ê–® –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ö–û–î taskDisplay (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    // –° —Ç–∞–∫–æ–π –∂–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
}

// ============================================================================
// –ó–ê–î–ê–ß–ê –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–ì–û –ü–û–†–¢–ê (–í–ê–®–ê –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø)
// ============================================================================
void taskSerial(void* pv) {
    // –í–ê–® –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ö–û–î taskSerial (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
}

// ============================================================================
// –ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê WI-FI (–ë–ï–ó–û–ü–ê–°–ù–ê–Ø –í–ï–†–°–ò–Ø)
// ============================================================================
void taskWiFi(void* pvParameters) {
    Serial.println("\n[WiFi] üöÄ –ó–ê–î–ê–ß–ê WI-FI –ó–ê–ü–£–©–ï–ù–ê");
    
    // –î–õ–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–î–ï–†–ñ–ö–ê –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã
    Serial.println("[WiFi] –û–∂–∏–¥–∞–Ω–∏–µ 5 —Å–µ–∫—É–Ω–¥...");
    for (int i = 5; i > 0; i--) {
        Serial.printf("[WiFi] %d...\n", i);
        vTaskDelay(pdMS_TO_TICKS(1000));
    }
    
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WI-FI
    Serial.println("[WiFi] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Wi-Fi...");
    wifi_ap_setup();
    
    Serial.println("[WiFi] ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª...");
    
    // –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ
    uint32_t loopCounter = 0;
    while (1) {
        loopCounter++;
        
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–∞–∑ –≤ 20 —Ü–∏–∫–ª–æ–≤
        if (loopCounter % 20 == 0) {
            print_stack_usage("WiFiTask");
        }
        
        // –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ Wi-Fi
        wifi_ap_loop();
        
        // –ü–∞—É–∑–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        vTaskDelay(pdMS_TO_TICKS(500)); // 500 –º—Å
    }
}

// ============================================================================
// –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø –í–°–ï–• –ó–ê–î–ê–ß
// ============================================================================
void create_rtos_tasks() {
    Serial.println("\n" + String(50, '='));
    Serial.println("–°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß FREERTOS");
    Serial.println(String(50, '='));
    
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç–µ–∫–æ–≤ (–≤ —Å–ª–æ–≤–∞—Ö)
    const configSTACK_DEPTH_TYPE STACK_MEASURE = 8192;
    const configSTACK_DEPTH_TYPE STACK_DISPLAY = 12288;
    const configSTACK_DEPTH_TYPE STACK_WIFI = 16384; // –ë–æ–ª—å—à–æ–π —Å—Ç–µ–∫ –¥–ª—è Wi-Fi
    const configSTACK_DEPTH_TYPE STACK_SERIAL = 4096;
    
    // 1. –ó–ê–î–ê–ß–ê –ò–ó–ú–ï–†–ï–ù–ò–ô (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3)
    if (xTaskCreatePinnedToCore(taskMeasure, "MeasureTask", STACK_MEASURE, NULL, 3, NULL, 1) == pdPASS) {
        Serial.println("‚úÖ MeasureTask —Å–æ–∑–¥–∞–Ω–∞");
    }
    vTaskDelay(pdMS_TO_TICKS(100));
    
    // 2. –ó–ê–î–ê–ß–ê –î–ò–°–ü–õ–ï–Ø (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2)
    if (xTaskCreatePinnedToCore(taskDisplay, "DisplayTask", STACK_DISPLAY, NULL, 2, NULL, 1) == pdPASS) {
        Serial.println("‚úÖ DisplayTask —Å–æ–∑–¥–∞–Ω–∞");
    }
    vTaskDelay(pdMS_TO_TICKS(100));
    
    // 3. –ó–ê–î–ê–ß–ê WI-FI (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 –¥–ª—è —Ç–µ—Å—Ç–∞)
    if (xTaskCreatePinnedToCore(taskWiFi, "WiFiTask", STACK_WIFI, NULL, 1, NULL, 1) == pdPASS) {
        Serial.println("‚úÖ WiFiTask —Å–æ–∑–¥–∞–Ω–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)");
        Serial.println("   ‚Üí Wi-Fi –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥");
    }
    vTaskDelay(pdMS_TO_TICKS(100));
    
    // 4. –ó–ê–î–ê–ß–ê SERIAL (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
    if (xTaskCreatePinnedToCore(taskSerial, "SerialTask", STACK_SERIAL, NULL, 1, NULL, 1) == pdPASS) {
        Serial.println("‚úÖ SerialTask —Å–æ–∑–¥–∞–Ω–∞");
    }
    
    // –ò—Ç–æ–≥
    Serial.println("\n" + String(50, '='));
    Serial.println("‚úÖ –í–°–ï –ó–ê–î–ê–ß–ò –°–û–ó–î–ê–ù–´");
    Serial.println(String(50, '=') + "\n");
}