/**
 * ============================================================================
 * –§–ê–ô–õ: rtos_tasks.cpp
 * –û–°–ù–û–í–ù–û–ô –§–ê–ô–õ –ó–ê–î–ê–ß FREERTOS –î–õ–Ø –°–ò–°–¢–ï–ú–´ –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –¢–ï–ú–ü–ï–†–ê–¢–£–†
 * 
 * –í–ï–†–°–ò–Ø: 4.0 (–° –ò–ù–¢–ï–ì–†–ê–¶–ò–ï–ô –≠–ù–ö–û–î–ï–†–ê)
 * –î–ê–¢–ê: [–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞]
 * 
 * –û–°–û–ë–ï–ù–ù–û–°–¢–ò:
 * 1. –ß–µ—Ç—ã—Ä–µ –∑–∞–¥–∞—á–∏ FreeRTOS: —ç–Ω–∫–æ–¥–µ—Ä, –∏–∑–º–µ—Ä–µ–Ω–∏—è, –¥–∏—Å–ø–ª–µ–π, serial
 * 2. –ú–µ—Ö–∞–Ω–∏–∑–º –æ—á–µ—Ä–µ–¥–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç–Ω–∫–æ–¥–µ—Ä–∞
 * 3. –ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (STATE_MAIN / STATE_MODE)
 * 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É (30 —Å–µ–∫)
 * 5. Heartbeat-—Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
 * ============================================================================
 */

#include "rtos_tasks.h"
#include "encoder_engine.h"  // –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç–Ω–∫–æ–¥–µ—Ä–æ–º (–Ω–æ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞)

// ============================================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–û–ù–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ (–ú–ê–ö–†–û–°–´)
// ============================================================================
#define HEARTBEAT_INTERVAL 30000     // –ò–Ω—Ç–µ—Ä–≤–∞–ª heartbeat-—Å–æ–æ–±—â–µ–Ω–∏–π: 30 —Å–µ–∫—É–Ω–¥
#define STACK_CHECK_INTERVAL 300000  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Å—Ç–µ–∫–∞: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
#define ENCODER_POLL_INTERVAL 10     // –ß–∞—Å—Ç–æ—Ç–∞ –æ–ø—Ä–æ—Å–∞ —ç–Ω–∫–æ–¥–µ—Ä–∞: 10 –º—Å (100 –ì—Ü)
#define INACTIVITY_TIMEOUT 30000     // –¢–∞–π–º–∞—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: 30 —Å–µ–∫—É–Ω–¥

// ============================================================================
// –õ–û–ö–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –î–ò–°–ü–õ–ï–Ø (–í–ò–î–ù–´ –¢–û–õ–¨–ö–û –í –≠–¢–û–ú –§–ê–ô–õ–ï)
// ============================================================================

// –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: 'systemState' —Ç–µ–ø–µ—Ä—å –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è (–æ–±—ä—è–≤–ª–µ–Ω–∞ –≤ temperature_system.ino)
// –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (0 = –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω, 1 = –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞)

static uint8_t selectedModeIndex = 0;  // –ò–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –≤ –º–µ–Ω—é:
                                       // 0 = MODE1 (—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è), 1 = MODE2 (—Ä–∞–±–æ—á–∏–π)
static uint32_t lastUserActivity = 0;  // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                       // (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω)

// ============================================================================
// –ó–ê–î–ê–ß–ê –≠–ù–ö–û–î–ï–†–ê (–ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê, –î–û–ë–ê–í–õ–ï–ù–ê –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ß–ï–†–ï–ó –≠–ù–ö–û–î–ï–†)
// ============================================================================
void taskEncoder(void* pv) {
  TickType_t lastWakeTime = xTaskGetTickCount(); // –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

  Serial.println("üéõÔ∏è  –ó–∞–¥–∞—á–∞ —ç–Ω–∫–æ–¥–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞");

  while (1) { // –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª - —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ FreeRTOS –¥–ª—è –∑–∞–¥–∞—á
    // 1. –û–ü–†–û–° –≠–ù–ö–û–î–ï–†–ê
    // –§—É–Ω–∫—Ü–∏—è encoder_tick() –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —ç–Ω–∫–æ–¥–µ—Ä –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
    EncoderEvent_t event = encoder_tick();

    // 2. –û–¢–ü–†–ê–í–ö–ê –°–û–ë–´–¢–ò–Ø –í –û–ß–ï–†–ï–î–¨ (–ï–°–õ–ò –ï–°–¢–¨)
    if (event != EVENT_NONE && eventQueue != NULL) {
      // –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (0 —Ç–∏–∫–æ–≤ –æ–∂–∏–¥–∞–Ω–∏—è)
      // –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø–æ–ª–Ω–∞ - —Å–æ–±—ã—Ç–∏–µ —Ç–µ—Ä—è–µ—Ç—Å—è (–ª—É—á—à–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Å–æ–±—ã—Ç–∏–µ, —á–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É)
      if (xQueueSend(eventQueue, &event, 0) != pdTRUE) {
        static uint32_t lastQueueError = 0;
        uint32_t now = pdTICKS_TO_MS(xTaskGetTickCount());
        
        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 5 —Å–µ–∫—É–Ω–¥
        if (now - lastQueueError > 5000) {
          Serial.println("‚ö†Ô∏è  [ENCODER] –û—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞");
          lastQueueError = now;
        }
      }
    }

    // 3. –¢–û–ß–ù–´–ô –ò–ù–¢–ï–†–í–ê–õ –û–ü–†–û–°–ê
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º vTaskDelayUntil –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ 10 –º—Å (100 –ì—Ü)
    vTaskDelayUntil(&lastWakeTime, pdMS_TO_TICKS(ENCODER_POLL_INTERVAL));
  }
}

// ============================================================================
// –ó–ê–î–ê–ß–ê –ò–ó–ú–ï–†–ï–ù–ò–ô (–° –£–õ–£–ß–®–ï–ù–ò–Ø–ú–ò, –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô –ü–û –°–†–ê–í–ù–ï–ù–ò–Æ –°–û –°–¢–ê–†–û–ô –í–ï–†–°–ò–ï–ô)
// ============================================================================
void taskMeasure(void* pv) {
  TickType_t lastWakeTime = xTaskGetTickCount();
  uint32_t lastDeltaTime = 0;
  float lastTemps[4] = { 0, 0, 0, 0 };
  uint32_t lastReconnectAttempt = 0;
  uint32_t lastHeartbeat = 0;
  uint32_t measurementCount = 0;

  Serial.println("üì° –ó–∞–¥–∞—á–∞ –∏–∑–º–µ—Ä–µ–Ω–∏–π –∑–∞–ø—É—â–µ–Ω–∞");

  while (1) {
    uint32_t currentMillis = pdTICKS_TO_MS(xTaskGetTickCount());
    measurementCount++;

    // 1. HEARTBEAT –î–õ–Ø –û–¢–õ–ê–î–ö–ò
    if (currentMillis - lastHeartbeat > HEARTBEAT_INTERVAL) {
      Serial.printf("[MEASURE] Heartbeat: %lu ms, –∏–∑–º–µ—Ä–µ–Ω–∏–π: %lu\n",
                    currentMillis, measurementCount);
      lastHeartbeat = currentMillis;
    }

    // 2. –ü–†–û–í–ï–†–ö–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –°–ò–°–¢–ï–ú–´
    // –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞—Ç—á–∏–∫–æ–≤) -
    // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –∏–∑–º–µ—Ä–µ–Ω–∏–π —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    if (!systemInitialized) {
      vTaskDelay(pdMS_TO_TICKS(100));
      continue;
    }

    // 3. –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ê–Ø –ü–û–ü–´–¢–ö–ê –ü–ï–†–ï–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –î–ê–¢–ß–ò–ö–û–í
    if (currentMillis - lastReconnectAttempt > RECONNECT_INTERVAL) {
      attemptReconnect();  // –§—É–Ω–∫—Ü–∏—è –ø—ã—Ç–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å —Å –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–º–∏ –¥–∞—Ç—á–∏–∫–∞–º–∏
      lastReconnectAttempt = currentMillis;
    }

    // 4. –ü–†–û–í–ï–†–ö–ê –ö–†–ò–¢–ò–ß–ï–°–ö–û–ô –û–®–ò–ë–ö–ò (–û–¢–°–£–¢–°–¢–í–ò–ï –ì–ò–õ–¨–ó–´)
    // –î–∞—Ç—á–∏–∫ –≥–∏–ª—å–∑—ã (sensors[3]) —è–≤–ª—è–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
    if (criticalError || !sensors[3].found) {
      vTaskDelay(pdMS_TO_TICKS(1000));
      continue;
    }

    // 5. –ó–ê–ü–†–û–° –¢–ï–ú–ü–ï–†–ê–¢–£–† –° –î–ê–¢–ß–ò–ö–û–í
    // –î–∞—Ç—á–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ —à–∏–Ω–µ 1-Wire, —Ç—Ä–µ–±—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏—é
    if (sensors[3].found) {
      sensorsA.requestTemperatures(); // –ó–∞–ø—Ä–æ—Å –¥–ª—è –¥–∞—Ç—á–∏–∫–∞ –≥–∏–ª—å–∑—ã (—à–∏–Ω–∞ A)
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–∞ –ª–∏ —à–∏–Ω–∞ B (–¥–∞—Ç—á–∏–∫–∏ —Å—Ç–µ–Ω–∫–∏)
    bool busBNeeded = false;
    for (int i = 0; i < 3; i++) {
      if (sensors[i].found) {
        busBNeeded = true;
        break;
      }
    }

    if (busBNeeded) {
      sensorsB.requestTemperatures(); // –ó–∞–ø—Ä–æ—Å –¥–ª—è –¥–∞—Ç—á–∏–∫–æ–≤ —Å—Ç–µ–Ω–∫–∏ (—à–∏–Ω–∞ B)
    }

    // 6. –û–ñ–ò–î–ê–ù–ò–ï –ö–û–ù–í–ï–†–°–ò–ò –î–ê–¢–ß–ò–ö–û–í
    // –î–∞—Ç—á–∏–∫–∞–º Dallas —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ä–µ–º—è –Ω–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
    // 750 –º—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è 11 –±–∏—Ç
    vTaskDelay(pdMS_TO_TICKS(750));

    // 7. –ß–¢–ï–ù–ò–ï –ò –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• –° –î–ê–¢–ß–ò–ö–û–í
    for (int i = 0; i < 4; i++) {
      if (sensors[i].found) {
        float rawTemp = 0;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å –∫–∞–∫–æ–π —à–∏–Ω—ã —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
        if (i == 3) {
          rawTemp = sensorsA.getTempC(sensors[i].addr); // –ì–∏–ª—å–∑–∞ - —à–∏–Ω–∞ A
        } else {
          rawTemp = sensorsB.getTempC(sensors[i].addr); // –°—Ç–µ–Ω–∫–∞ - —à–∏–Ω–∞ B
        }

        // –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –î–ê–¢–ß–ò–ö–ê
        if (rawTemp == DEVICE_DISCONNECTED_C || !isValidTemperature(rawTemp)) {
          // –ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∏–ª–∏ –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
          sensors[i].temp = TEMP_NO_DATA;
          safeUpdateSystemData(i, TEMP_NO_DATA, 0.0f);
          sensors[i].lostTimer++;

          // –ü–æ–º–µ—á–∞–µ–º –¥–∞—Ç—á–∏–∫ –∫–∞–∫ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–π –ø–æ—Å–ª–µ 10 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥—Ä—è–¥
          if (sensors[i].lostTimer > 10) {
            sensors[i].found = false;
            if (i == 3) { // –ï—Å–ª–∏ —ç—Ç–æ –≥–∏–ª—å–∑–∞ - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
              criticalError = true;
              systemInitialized = false;
            }
            Serial.printf("‚ö†Ô∏è  %s –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–π\n", sensorNames[i]);
          }
        } else {
          // –ù–û–†–ú–ê–õ–¨–ù–û–ï –ß–¢–ï–ù–ò–ï - –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –û–ë–ù–û–í–õ–ï–ù–ò–ï
          sensors[i].lostTimer = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
          sensors[i].temp = filterValue(i, rawTemp); // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–µ–¥–∏–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä

          // –†–ê–°–ß–ï–¢ –î–ï–õ–¨–¢–´ –†–ê–ó –í DELTA_CALC_INTERVAL (2 –°–ï–ö–£–ù–î–´)
          if (currentMillis - lastDeltaTime > DELTA_CALC_INTERVAL) {
            if (lastTemps[i] != 0) {
              float delta = sensors[i].temp - lastTemps[i];
              safeUpdateSystemData(i, sensors[i].temp, delta);
            } else {
              safeUpdateSystemData(i, sensors[i].temp, 0.0f);
            }
            lastTemps[i] = sensors[i].temp;
          } else {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∏–∑–≤–µ—Å—Ç–Ω—É—é –¥–µ–ª—å—Ç—É
            safeUpdateSystemData(i, sensors[i].temp, sysData.deltas[i]);
          }
        }
      } else {
        // –î–ê–¢–ß–ò–ö –ù–ï –ù–ê–ô–î–ï–ù - –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ö–û–î –û–®–ò–ë–ö–ò
        if (i == 3) {
          safeUpdateSystemData(i, TEMP_CRITICAL_LOST, 0.0f);
          criticalError = true;
          systemInitialized = false;
        } else {
          safeUpdateSystemData(i, TEMP_SENSOR_LOST, 0.0f);
        }
      }
    }

    // 8. –°–ë–†–û–° –¢–ê–ô–ú–ï–†–ê –î–ï–õ–¨–¢ (–†–ê–ó –í 2 –°–ï–ö–£–ù–î–´)
    if (currentMillis - lastDeltaTime > DELTA_CALC_INTERVAL) {
      lastDeltaTime = currentMillis;
    }

    // 9. –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –í –û–ß–ï–†–ï–î–¨ –î–õ–Ø –î–ò–°–ü–õ–ï–Ø
    if (dataQueue != NULL) {
      SystemData_t dataToSend;
      safeReadSystemData(&dataToSend); // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥ –º—å—é—Ç–µ–∫—Å–æ–º

      // –ù–ï–ë–õ–û–ö–ò–†–£–Æ–©–ê–Ø –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å –¥–∏—Å–ø–ª–µ—è
      if (xQueueSend(dataQueue, &dataToSend, 0) != pdTRUE) {
        static uint32_t lastQueueError = 0;
        if (currentMillis - lastQueueError > 5000) {
          Serial.println("‚ö†Ô∏è  –û—á–µ—Ä–µ–¥—å –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞ (–¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã)");
          lastQueueError = currentMillis;
        }
      }
    }

    // 10. –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ô–ú–ï–†–ê –°–¢–ê–ë–ò–õ–ò–ó–ê–¶–ò–ò –î–õ–Ø MODE1
    if (sysData.mode == 0 && sensors[3].found) {
      float guildTemp = sysData.temps[3];
      mode1_update_stabilization_timer(guildTemp);
    }

    // 11. –¢–û–ß–ù–û–ï –í–†–ï–ú–Ø –¶–ò–ö–õ–ê (1 –°–ï–ö–£–ù–î–ê –ú–ï–ñ–î–£ –ò–ó–ú–ï–†–ï–ù–ò–Ø–ú–ò)
    vTaskDelayUntil(&lastWakeTime, pdMS_TO_TICKS(MEASURE_INTERVAL));
  }
}

// ============================================================================
// –ó–ê–î–ê–ß–ê –î–ò–°–ü–õ–ï–Ø (–ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ê –î–õ–Ø –ü–û–î–î–ï–†–ñ–ö–ò –≠–ù–ö–û–î–ï–†–ê –ò –ú–ê–®–ò–ù–´ –°–û–°–¢–û–Ø–ù–ò–ô)
// ============================================================================
void taskDisplay(void* pv) {
  SystemData_t displayData;
  uint32_t lastUpdateTime = 0;
  uint32_t lastHeartbeat = 0;
  uint32_t lastStackCheck = 0;
  uint32_t displayUpdates = 0;
  uint32_t lastDisplayMode = 0xFF;

  Serial.println("üñ•Ô∏è  –ó–∞–¥–∞—á–∞ –¥–∏—Å–ø–ª–µ—è –∑–∞–ø—É—â–µ–Ω–∞");

  // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ê–ô–ú–ï–†–ê –ù–ï–ê–ö–¢–ò–í–ù–û–°–¢–ò
  lastUserActivity = pdTICKS_TO_MS(xTaskGetTickCount());

  while (1) {
    uint32_t currentMillis = pdTICKS_TO_MS(xTaskGetTickCount());

    // 1. HEARTBEAT –î–õ–Ø –û–¢–õ–ê–î–ö–ò
    if (currentMillis - lastHeartbeat > HEARTBEAT_INTERVAL) {
      UBaseType_t stackFree = uxTaskGetStackHighWaterMark(NULL);
      Serial.printf("[DISPLAY] Heartbeat: —Å—Ç–µ–π—Ç=%d, –≤—ã–±–æ—Ä=%d, –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å=%lu —Å–µ–∫\n",
                    systemState, selectedModeIndex,
                    (currentMillis - lastUserActivity) / 1000);
      lastHeartbeat = currentMillis;
    }

    // 2. –ü–†–û–í–ï–†–ö–ê –¢–ê–ô–ú–ê–£–¢–ê –ù–ï–ê–ö–¢–ò–í–ù–û–°–¢–ò (30 –°–ï–ö–£–ù–î)
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω 30 —Å–µ–∫—É–Ω–¥ –∏ –Ω–µ –≤ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è
    if (systemState != 0 && (currentMillis - lastUserActivity > INACTIVITY_TIMEOUT)) {
      Serial.println("[DISPLAY] –¢–∞–π–º–∞—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ - –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω");
      systemState = 0;                   // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ STATE_MAIN
      forceDisplayRedraw = true;         // –¢—Ä–µ–±—É–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É
      lastUserActivity = currentMillis;  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
    }

    // 3. –ü–†–û–í–ï–†–ö–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –°–ò–°–¢–ï–ú–´
    if (!systemInitialized) {
      vTaskDelay(pdMS_TO_TICKS(100));
      continue;
    }

    // 4. –û–ë–ù–û–í–õ–ï–ù–ò–ï –§–õ–ê–ì–ê –ö–†–ò–¢–ò–ß–ï–°–ö–û–ô –û–®–ò–ë–ö–ò
    criticalError = !sensors[3].found; // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ = –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≥–∏–ª—å–∑—ã

    // 5. –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô –≠–ù–ö–û–î–ï–†–ê (–ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–û–ú)
    EncoderEvent_t encoderEvent;
    if (eventQueue != NULL) {
      // –ß–∏—Ç–∞–µ–º –í–°–ï —Å–æ–±—ã—Ç–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏ (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Ä–µ–∂–∏–º, —Ç–∞–π–º–∞—É—Ç 0)
      while (xQueueReceive(eventQueue, &encoderEvent, 0) == pdTRUE) {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –õ–Æ–ë–û–ú –¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        lastUserActivity = currentMillis;

        // –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –¢–ï–ö–£–©–ï–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø
        switch (systemState) {
          case 0:  // STATE_MAIN (–ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù –° –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê–ú–ò)
            if (encoderEvent == EVENT_BUTTON_CLICK) {
              // –ö–û–†–û–¢–ö–û–ï –ù–ê–ñ–ê–¢–ò–ï: –ø–µ—Ä–µ—Ö–æ–¥ –≤ —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
              Serial.println("[DISPLAY] –ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∂–∞—Ç–∏–µ -> –ø–µ—Ä–µ—Ö–æ–¥ –≤ STATE_MODE");
              systemState = 1;                   // –ú–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
              selectedModeIndex = sysData.mode;  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π
              forceDisplayRedraw = true;         // –¢—Ä–µ–±—É–µ–º –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É
            }
            break;

          case 1:  // STATE_MODE (–≠–ö–†–ê–ù –í–´–ë–û–†–ê –†–ï–ñ–ò–ú–ê)
            switch (encoderEvent) {
              case EVENT_BUTTON_CLICK:
                // –ö–û–†–û–¢–ö–û–ï –ù–ê–ñ–ê–¢–ò–ï: –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                Serial.println("[DISPLAY] –ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∂–∞—Ç–∏–µ -> –≤–æ–∑–≤—Ä–∞—Ç –≤ STATE_MAIN");
                systemState = 0;
                forceDisplayRedraw = true;
                break;

              case EVENT_BUTTON_DOUBLE:
                // –î–í–û–ô–ù–û–ï –ù–ê–ñ–ê–¢–ò–ï: –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
                Serial.printf("[DISPLAY] –î–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ -> –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ %d\n", selectedModeIndex);
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
                resetDisplayState(selectedModeIndex);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
                systemState = 0;
                forceDisplayRedraw = true;
                break;

              case EVENT_ENCODER_LEFT:
                // –ü–û–í–û–†–û–¢ –í–õ–ï–í–û: –≤—ã–±–æ—Ä MODE1
                Serial.println("[DISPLAY] –ü–æ–≤–æ—Ä–æ—Ç –≤–ª–µ–≤–æ -> –≤—ã–±–æ—Ä MODE1");
                selectedModeIndex = 0; // MODE1
                forceDisplayRedraw = true;
                break;

              case EVENT_ENCODER_RIGHT:
                // –ü–û–í–û–†–û–¢ –í–ü–†–ê–í–û: –≤—ã–±–æ—Ä MODE2
                Serial.println("[DISPLAY] –ü–æ–≤–æ—Ä–æ—Ç –≤–ø—Ä–∞–≤–æ -> –≤—ã–±–æ—Ä MODE2");
                selectedModeIndex = 1; // MODE2
                forceDisplayRedraw = true;
                break;

              default:
                // –î—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                break;
            }
            break;
        }
      }
    }

    // 6. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ò–ó –û–ß–ï–†–ï–î–ò –¢–ï–ú–ü–ï–†–ê–¢–£–†
    bool newDataReceived = false;
    if (dataQueue != NULL) {
      // –ß—Ç–µ–Ω–∏–µ —Å —Ç–∞–π–º–∞—É—Ç–æ–º 100 –º—Å (–µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º—Å—è –Ω–∞–¥–æ–ª–≥–æ)
      if (xQueueReceive(dataQueue, &displayData, pdMS_TO_TICKS(100)) == pdTRUE) {
        newDataReceived = true;
        displayUpdates++;

        // 6.1 –ë–ï–ó–û–ü–ê–°–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–ù–´–• –î–ê–ù–ù–´–• (–ü–û–î –ú–¨–Æ–¢–ï–ö–°–û–ú)
        if (xSemaphoreTake(dataMutex, pdMS_TO_TICKS(15)) == pdTRUE) {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π —Ä–µ–∂–∏–º –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–º–µ–Ω—ã
          uint8_t oldMode = sysData.mode;

          // –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É sysData
          sysData.mode = displayData.mode;
          sysData.needsRedraw = displayData.needsRedraw;
          memcpy(sysData.temps, displayData.temps, sizeof(float) * 4);
          memcpy(sysData.deltas, displayData.deltas, sizeof(float) * 4);

          // –û–ë–ù–ê–†–£–ñ–ï–ù–ò–ï –°–ú–ï–ù–´ –†–ï–ñ–ò–ú–ê
          if (sysData.mode != oldMode) {
            Serial.printf("[DISPLAY] –°–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞: %d -> %d\n",
                          oldMode, sysData.mode);
            lastDisplayMode = sysData.mode;
            forceDisplayRedraw = true; // –ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
          }

          xSemaphoreGive(dataMutex); // –í–ê–ñ–ù–û: –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—É—Å–∫–∞–µ–º –º—å—é—Ç–µ–∫—Å
        }
      }
    }

    // 7. –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ò–°–ü–õ–ï–Ø
    // –û–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏: 1) –ø—Ä–∏—à–ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, 2) –ø—Ä–æ—à–ª–æ DISPLAY_UPDATE_MS,
    // 3) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–ª–∞–≥ forceDisplayRedraw (–ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ –∏–ª–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É)
    if (newDataReceived || (currentMillis - lastUpdateTime >= DISPLAY_UPDATE_MS) || forceDisplayRedraw) {

      // 7.1 –û–ë–ù–û–í–õ–ï–ù–ò–ï –¶–í–ï–¢–û–í–û–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø (–¢–û–õ–¨–ö–û –î–õ–Ø MODE2)
      if (sysData.mode == 1 && sensors[3].found && guildBaseTemp != 0.0f) {
        // –ë–µ—Ä–µ–º –º—å—é—Ç–µ–∫—Å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –≥–∏–ª—å–∑—ã
        float currentGuildTemp = 0.0f;
        if (xSemaphoreTake(dataMutex, pdMS_TO_TICKS(5)) == pdTRUE) {
          currentGuildTemp = sysData.temps[3];
          xSemaphoreGive(dataMutex);
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–∞–ª–∏–¥–Ω–∞
        if (isValidTemperature(currentGuildTemp)) {
          mode2_update_color_state(currentGuildTemp);
        }
      }

      // 7.2 –í–´–ë–û–† –ò –í–´–ó–û–í –§–£–ù–ö–¶–ò–ò –û–¢–†–ò–°–û–í–ö–ò –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –°–û–°–¢–û–Ø–ù–ò–Ø
      switch (systemState) {
        case 0:  // STATE_MAIN - –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù –° –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê–ú–ò
          if (sysData.mode == 0) {
            updateDisplayMODE1(); // –†–µ–∂–∏–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ (—Å–∏–Ω–∏–π —Ñ–æ–Ω)
          } else {
            // –†–µ–∂–∏–º MODE2 —Å —Ü–≤–µ—Ç–æ–≤—ã–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
            switch (guildColorState) {
              case 0:
                updateDisplayMODE2_GREEN(); // –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω
                break;
              case 1:
                updateDisplayMODE2_YELLOW(); // –ñ–µ–ª—Ç—ã–π —Ñ–æ–Ω
                break;
              case 2:
                updateDisplayMODE2_RED(); // –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω
                break;
              default:
                updateDisplayMODE1(); // –§–æ–ª–±—ç–∫
                break;
            }
          }
          break;

        case 1:  // STATE_MODE - –≠–ö–†–ê–ù –í–´–ë–û–†–ê –†–ï–ñ–ò–ú–ê
          // –í–†–ï–ú–ï–ù–ù–ê–Ø –ó–ê–ì–õ–£–®–ö–ê: –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω –∏ –≤—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç
          // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –æ—Ç—Ä–∏—Å–æ–≤–∫—É —Å –∫—É—Ä—Å–æ—Ä–æ–º –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
          tft.fillScreen(COLOR_BLACK);
          tft.setTextColor(COLOR_WHITE, COLOR_BLACK);
          tft.setTextFont(FONT_BIG);
          tft.setCursor(50, 50);
          tft.printf("–í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞: %s", selectedModeIndex == 0 ? "MODE1" : "MODE2");
          tft.setCursor(50, 100);
          tft.printf("–¢–µ–∫—É—â–∏–π: %s", sysData.mode == 0 ? "MODE1" : "MODE2");
          tft.setCursor(50, 150);
          tft.print("–ö–Ω–æ–ø–∫–∞ - –Ω–∞–∑–∞–¥, 2x–ö–Ω–æ–ø–∫–∞ - –ø—Ä–∏–º–µ–Ω–∏—Ç—å");
          break;

        default:
          // –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
          systemState = 0;
          updateDisplayMODE1();
          break;
      }

      lastUpdateTime = currentMillis;
      forceDisplayRedraw = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    }

    // 8. –ö–û–†–û–¢–ö–ê–Ø –ü–ê–£–ó–ê –î–õ–Ø –î–†–£–ì–ò–• –ó–ê–î–ê–ß
    // 20 –º—Å = 50 FPS –º–∞–∫—Å–∏–º—É–º, —Ä–µ–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ DISPLAY_UPDATE_MS (500 –º—Å)
    vTaskDelay(pdMS_TO_TICKS(20));
  }
}

// ============================================================================
// –ó–ê–î–ê–ß–ê SERIAL (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô, –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î –° –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–ì–û –ü–û–†–¢–ê)
// ============================================================================
void taskSerial(void* pv) {
  uint32_t lastHeartbeat = 0;
  uint32_t commandCount = 0;

  Serial.println("üìü –ó–∞–¥–∞—á–∞ Serial –∑–∞–ø—É—â–µ–Ω–∞");

  while (1) {
    uint32_t currentMillis = pdTICKS_TO_MS(xTaskGetTickCount());

    // 1. HEARTBEAT –î–õ–Ø –û–¢–õ–ê–î–ö–ò
    if (currentMillis - lastHeartbeat > HEARTBEAT_INTERVAL) {
      Serial.printf("[SERIAL] Heartbeat: %lu ms, –∫–æ–º–∞–Ω–¥: %lu\n",
                    currentMillis, commandCount);
      lastHeartbeat = currentMillis;
    }

    // 2. –û–ë–†–ê–ë–û–¢–ö–ê –í–í–û–î–ê –° –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–ì–û –ü–û–†–¢–ê
    serial_handle_input(); // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (HELP, MODE1, MODE2 –∏ —Ç.–¥.)
    commandCount++;

    // 3. –ü–ê–£–ó–ê –ú–ï–ñ–î–£ –ü–†–û–í–ï–†–ö–ê–ú–ò
    // 50 –º—Å = 20 –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ —Å–µ–∫—É–Ω–¥—É (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
    vTaskDelay(pdMS_TO_TICKS(50));
  }
}

// ============================================================================
// –°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß FREERTOS (–û–ë–ù–û–í–õ–ï–ù–ê –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ó–ê–î–ê–ß–ò –≠–ù–ö–û–î–ï–†–ê)
// ============================================================================
void create_rtos_tasks() {
  Serial.println("\n" + String(50, '='));
  Serial.println("–°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß FREERTOS (–í–ï–†–°–ò–Ø 4.0 –° –≠–ù–ö–û–î–ï–†–û–ú)");
  Serial.println(String(50, '='));

  // 1. –ó–ê–î–ê–ß–ê –≠–ù–ö–û–î–ï–†–ê (–ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê, –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ –î–õ–Ø –ë–´–°–¢–†–û–ì–û –û–¢–ö–õ–ò–ö–ê)
  if (xTaskCreatePinnedToCore(
        taskEncoder,      // –§—É–Ω–∫—Ü–∏—è –∑–∞–¥–∞—á–∏
        "EncoderTask",    // –ò–º—è –∑–∞–¥–∞—á–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        4096,             // –†–∞–∑–º–µ—Ä —Å—Ç–µ–∫–∞: 4KB (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π –∑–∞–¥–∞—á–∏)
        NULL,             // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
        4,                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: 4 (–≤—ã—Å–æ–∫–∏–π) - –≤–∞–∂–µ–Ω –±—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫ –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è
        NULL,             // –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –∑–∞–¥–∞—á–∏ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º)
        1)                // –Ø–¥—Ä–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞: 1 (–∫–∞–∫ –∏ –≤—Å–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏)
      != pdPASS) {
    Serial.println("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É —ç–Ω–∫–æ–¥–µ—Ä–∞!");
    tft.fillScreen(COLOR_RED);
    tft.setCursor(20, 100);
    tft.print("–û–®–ò–ë–ö–ê: EncoderTask");
    while (1) vTaskDelay(pdMS_TO_TICKS(1000)); // –ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
  }
  Serial.println("‚úÖ –ó–∞–¥–∞—á–∞ —ç–Ω–∫–æ–¥–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4, —è–¥—Ä–æ 1, —Å—Ç–µ–∫ 4KB)");

  // 2. –ó–ê–î–ê–ß–ê –ò–ó–ú–ï–†–ï–ù–ò–ô (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ - –î–û–õ–ñ–ù–ê –†–ê–ë–û–¢–ê–¢–¨ –¢–û–ß–ù–û –ü–û –í–†–ï–ú–ï–ù–ò)
  if (xTaskCreatePinnedToCore(
        taskMeasure,
        "MeasureTask",
        8192,  // 8KB —Å—Ç–µ–∫–∞ (–±–æ–ª—å—à–µ –∏–∑-–∑–∞ —Å–ª–æ–∂–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∏ –±—É—Ñ–µ—Ä–æ–≤)
        NULL,
        3,  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–≤—ã—Å–æ–∫–∏–π, –Ω–æ –Ω–∏–∂–µ —ç–Ω–∫–æ–¥–µ—Ä–∞)
        NULL,
        1)
      != pdPASS) {
    Serial.println("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –∏–∑–º–µ—Ä–µ–Ω–∏–π!");
    tft.fillScreen(COLOR_RED);
    tft.setCursor(20, 120);
    tft.print("–û–®–ò–ë–ö–ê: MeasureTask");
    while (1) vTaskDelay(pdMS_TO_TICKS(1000));
  }
  Serial.println("‚úÖ –ó–∞–¥–∞—á–∞ –∏–∑–º–µ—Ä–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3, —è–¥—Ä–æ 1, —Å—Ç–µ–∫ 8KB)");

  // 3. –ó–ê–î–ê–ß–ê –î–ò–°–ü–õ–ï–Ø (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)
  if (xTaskCreatePinnedToCore(
        taskDisplay,
        "DisplayTask",
        12288,  // 12KB —Å—Ç–µ–∫–∞ (–º–Ω–æ–≥–æ –∏–∑-–∑–∞ –±—É—Ñ–µ—Ä–æ–≤ –¥–∏—Å–ø–ª–µ—è –∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
        NULL,
        2,  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (—Å—Ä–µ–¥–Ω–∏–π)
        NULL,
        1)
      != pdPASS) {
    Serial.println("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –¥–∏—Å–ø–ª–µ—è!");
    tft.fillScreen(COLOR_RED);
    tft.setCursor(20, 140);
    tft.print("–û–®–ò–ë–ö–ê: DisplayTask");
    while (1) vTaskDelay(pdMS_TO_TICKS(1000));
  }
  Serial.println("‚úÖ –ó–∞–¥–∞—á–∞ –¥–∏—Å–ø–ª–µ—è —Å–æ–∑–¥–∞–Ω–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2, —è–¥—Ä–æ 1, —Å—Ç–µ–∫ 12KB)");

  // 4. –ó–ê–î–ê–ß–ê SERIAL (–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ - –ö–û–ú–ê–ù–î–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ù–ï –ö–†–ò–¢–ò–ß–ù–´ –ü–û –í–†–ï–ú–ï–ù–ò)
  if (xTaskCreatePinnedToCore(
        taskSerial,
        "SerialTask",
        4096,  // 4KB —Å—Ç–µ–∫–∞
        NULL,
        1,  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–Ω–∏–∑–∫–∏–π)
        NULL,
        1)
      != pdPASS) {
    Serial.println("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É Serial!");
    tft.fillScreen(COLOR_RED);
    tft.setCursor(20, 160);
    tft.print("–û–®–ò–ë–ö–ê: SerialTask");
    while (1) vTaskDelay(pdMS_TO_TICKS(1000));
  }
  Serial.println("‚úÖ –ó–∞–¥–∞—á–∞ Serial —Å–æ–∑–¥–∞–Ω–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1, —è–¥—Ä–æ 1, —Å—Ç–µ–∫ 4KB)");

  // 5. –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ò–°–¢–ï–ú–ï –ò –ó–ê–í–ï–†–®–ï–ù–ò–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
  Serial.println("\n" + String(60, '='));
  Serial.println("‚úÖ –°–ò–°–¢–ï–ú–ê –£–°–ü–ï–®–ù–û –ó–ê–ü–£–©–ï–ù–ê");
  Serial.println(String(60, '='));
  Serial.println("–û–°–û–ë–ï–ù–ù–û–°–¢–ò –≠–¢–û–ô –í–ï–†–°–ò–ò:");
  Serial.println("  1. Heartbeat –≤–æ –≤—Å–µ—Ö –∑–∞–¥–∞—á–∞—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–π");
  Serial.println("  2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Å—Ç–µ–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç");
  Serial.println("  3. –ú—å—é—Ç–µ–∫—Å dataMutex –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ö–û–ù–°–ò–°–¢–ï–ù–¢–ù–û");
  Serial.println("  4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –º—å—é—Ç–µ–∫—Å–∞");
  Serial.println("  5. –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å (—Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è)");
  Serial.println("  6. –û—Ç–¥–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è");
  Serial.println("  7. –ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —ç–Ω–∫–æ–¥–µ—Ä —Å –æ—á–µ—Ä–µ–¥—å—é —Å–æ–±—ã—Ç–∏–π");
  Serial.println("  8. –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (STATE_MAIN/MODE)");
  Serial.println("  9. –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ê–≤—Ç–æ-–≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É");
  Serial.println(String(60, '='));

  // 6. –ü–†–û–í–ï–†–ö–ê –°–¢–ï–ö–ê –û–°–ù–û–í–ù–û–ô –ó–ê–î–ê–ß–ò (–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê)
  vTaskDelay(pdMS_TO_TICKS(2000));  // –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã
  UBaseType_t mainStack = uxTaskGetStackHighWaterMark(NULL);
  Serial.printf("[INIT] –°—Ç–µ–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–¥–∞—á–∏: %u —Å–ª–æ–≤ (%u –±–∞–π—Ç)\n",
                mainStack, mainStack * 4);

  if (mainStack < 200) {
    Serial.println("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ú–∞–ª–æ —Å—Ç–µ–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–¥–∞—á–µ!");
  }

  Serial.println("\nüî• –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!");
  Serial.println("üéõÔ∏è  –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–Ω–∫–æ–¥–µ—Ä –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏");
  Serial.println("üìã –í–≤–µ–¥–∏—Ç–µ HELP –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥");
  Serial.println(String(60, '=') + "\n");
}

// ============================================================================
// –ö–û–ù–ï–¶ –§–ê–ô–õ–ê rtos_tasks.cpp
// ============================================================================